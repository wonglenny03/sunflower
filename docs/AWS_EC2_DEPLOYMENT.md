# AWS EC2 部署配置指南

## 项目资源需求分析

### 技术栈
- **后端**: NestJS (Node.js 18+)
- **前端**: Next.js 14 (Node.js 18+)
- **数据库**: PostgreSQL 14+
- **包管理**: pnpm 8+
- **外部服务**: OpenAI API, SMTP 邮件服务

### 资源消耗评估
- **内存**: Node.js 应用、PostgreSQL、构建过程
- **CPU**: TypeScript 编译、数据库查询、API 处理
- **存储**: 数据库数据、node_modules、构建产物
- **网络**: API 调用、邮件发送

---

## EC2 实例配置建议

### 方案一：单机部署（推荐用于小规模生产环境）

**实例类型**: `t3.medium` 或 `t3.large`

#### t3.medium 配置
- **vCPU**: 2
- **内存**: 4 GB
- **网络性能**: 最高 5 Gbps
- **存储**: 20-30 GB EBS (gp3)
- **适用场景**: 
  - 用户数 < 50
  - 并发请求 < 20
  - 数据库记录 < 10,000 条
- **月费用**: 约 $30-40 USD

#### t3.large 配置（推荐）
- **vCPU**: 2
- **内存**: 8 GB
- **网络性能**: 最高 5 Gbps
- **存储**: 30-50 GB EBS (gp3)
- **适用场景**:
  - 用户数 50-200
  - 并发请求 20-50
  - 数据库记录 10,000-100,000 条
- **月费用**: 约 $60-80 USD

**部署架构**:
```
EC2 Instance
├── PostgreSQL (本地或 RDS)
├── NestJS API (端口 3001)
└── Next.js Web (端口 3000)
```

---

### 方案二：分离部署（推荐用于中等规模生产环境）

#### 应用服务器 (t3.large 或 t3.xlarge)
- **vCPU**: 2-4
- **内存**: 8-16 GB
- **存储**: 20-30 GB EBS (gp3)
- **运行**: NestJS API + Next.js Web

#### 数据库服务器 (db.t3.medium RDS 或 t3.medium EC2)
- **vCPU**: 2
- **内存**: 4 GB
- **存储**: 100 GB gp3 (可扩展)
- **运行**: PostgreSQL

**优势**:
- 数据库和应用分离，便于扩展
- 可以使用 RDS 自动备份
- 更好的性能隔离

**月费用**: 约 $100-150 USD

---

### 方案三：高性能部署（大规模生产环境）

#### 应用服务器 (t3.xlarge 或 c5.xlarge)
- **vCPU**: 4
- **内存**: 16-32 GB
- **存储**: 50 GB EBS (gp3)
- **运行**: NestJS API + Next.js Web

#### 数据库服务器 (db.t3.large RDS)
- **vCPU**: 2
- **内存**: 8 GB
- **存储**: 200 GB+ gp3
- **运行**: PostgreSQL

#### 可选：负载均衡器 (Application Load Balancer)
- 用于多实例部署
- 高可用性

**月费用**: 约 $200-300 USD

---

## 详细配置说明

### 1. 操作系统选择

**推荐**: Ubuntu 22.04 LTS 或 Amazon Linux 2023

```bash
# Ubuntu 22.04 LTS (推荐)
- 长期支持，稳定性好
- 软件包更新及时
- 社区支持完善

# Amazon Linux 2023
- AWS 优化
- 预装 AWS CLI
- 与 AWS 服务集成更好
```

### 2. 存储配置

#### EBS 卷配置
- **类型**: gp3 (推荐) 或 gp2
- **大小**: 
  - 最小: 30 GB
  - 推荐: 50 GB
  - 生产: 100 GB+
- **IOPS**: 
  - gp3: 3000 IOPS (默认) 或更高
  - gp2: 根据卷大小自动分配

#### 存储分配建议
```
/ (根分区): 20 GB
/home: 10 GB
/var/lib/postgresql: 20-50 GB (如果本地部署数据库)
/opt/app: 10 GB (应用代码和构建产物)
```

### 3. 网络配置

#### 安全组规则

**入站规则**:
```
HTTP (80): 0.0.0.0/0          # 前端访问
HTTPS (443): 0.0.0.0/0        # 前端访问（如果使用 SSL）
API (3001): 0.0.0.0/0 或特定 IP  # 后端 API（建议限制）
SSH (22): 你的 IP 地址        # 管理访问
PostgreSQL (5432): 仅应用服务器 IP  # 数据库访问
```

**出站规则**:
```
全部流量: 0.0.0.0/0           # 允许所有出站流量
```

### 4. 内存分配建议

**8 GB 内存分配**:
```
操作系统: 1 GB
PostgreSQL: 2-3 GB
NestJS API: 1-2 GB
Next.js Web: 1-2 GB
系统缓存: 1 GB
```

**16 GB 内存分配**:
```
操作系统: 1-2 GB
PostgreSQL: 4-6 GB
NestJS API: 2-3 GB
Next.js Web: 2-3 GB
系统缓存: 2-3 GB
```

---

## 部署架构选项

### 选项 A：单机部署（最简单）

```
┌─────────────────────────────────┐
│      EC2 Instance (t3.large)    │
│                                 │
│  ┌──────────┐  ┌──────────┐   │
│  │ Next.js  │  │ NestJS   │   │
│  │  :3000   │  │  :3001   │   │
│  └──────────┘  └──────────┘   │
│                                 │
│  ┌──────────────────────────┐  │
│  │   PostgreSQL :5432       │  │
│  └──────────────────────────┘  │
└─────────────────────────────────┘
```

**优点**:
- 成本最低
- 部署简单
- 适合小规模使用

**缺点**:
- 单点故障
- 扩展性有限
- 资源竞争

---

### 选项 B：应用 + RDS（推荐）

```
┌──────────────────┐      ┌──────────────────┐
│  EC2 (t3.large)  │      │  RDS PostgreSQL  │
│                  │      │   (db.t3.medium) │
│  ┌──────────┐   │      │                  │
│  │ Next.js  │   │◄─────┤  :5432           │
│  │  :3000   │   │      │                  │
│  └──────────┘   │      └──────────────────┘
│  ┌──────────┐   │
│  │ NestJS   │   │
│  │  :3001   │   │
│  └──────────┘   │
└──────────────────┘
```

**优点**:
- 数据库自动备份
- 更好的性能隔离
- 易于扩展数据库
- 高可用性选项

**缺点**:
- 成本稍高
- 需要配置网络连接

---

### 选项 C：完全分离（高性能）

```
┌──────────────────┐
│  Application LB  │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│ EC2-1 │ │ EC2-2 │  (应用服务器)
│ App   │ │ App   │
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         │
    ┌────▼────┐
    │   RDS   │  (数据库)
    │ Postgres│
    └─────────┘
```

**优点**:
- 高可用性
- 负载均衡
- 易于扩展
- 最佳性能

**缺点**:
- 成本最高
- 配置复杂

---

## 系统要求清单

### 最小配置（测试/开发）
- **实例**: t3.small
- **vCPU**: 2
- **内存**: 2 GB
- **存储**: 20 GB
- **适用**: 个人测试、开发环境
- **限制**: 性能有限，不适合生产

### 推荐配置（小规模生产）
- **实例**: t3.medium 或 t3.large
- **vCPU**: 2
- **内存**: 4-8 GB
- **存储**: 30-50 GB
- **适用**: 小团队、初期生产环境
- **用户数**: < 100 并发用户

### 高性能配置（大规模生产）
- **应用服务器**: t3.xlarge 或 c5.xlarge
- **数据库**: db.t3.large RDS 或更高
- **vCPU**: 4+
- **内存**: 16 GB+
- **存储**: 100 GB+
- **适用**: 大规模生产环境
- **用户数**: 100+ 并发用户

---

## 软件安装清单

### 必需软件
```bash
# Node.js 18+ LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# pnpm
npm install -g pnpm

# PostgreSQL 14+ (如果本地部署)
sudo apt-get install postgresql postgresql-contrib

# PM2 (进程管理)
npm install -g pm2

# Nginx (反向代理，可选但推荐)
sudo apt-get install nginx

# Git
sudo apt-get install git
```

### 可选软件
```bash
# Docker (如果使用容器部署)
sudo apt-get install docker.io docker-compose

# Certbot (SSL 证书)
sudo apt-get install certbot python3-certbot-nginx
```

---

## 性能优化建议

### 1. 数据库优化
- 使用 RDS 自动备份
- 配置连接池
- 添加适当的索引
- 定期清理旧数据

### 2. 应用优化
- 使用 PM2 管理进程
- 启用 Node.js 集群模式
- 配置 Nginx 反向代理
- 启用 Gzip 压缩
- 使用 CDN 加速静态资源

### 3. 监控和日志
- 配置 CloudWatch 监控
- 设置日志轮转
- 监控 CPU、内存、磁盘使用率
- 设置告警

---

## 成本估算

### 单机部署 (t3.large)
```
EC2 实例 (t3.large):     $60/月
EBS 存储 (50 GB gp3):    $4/月
数据传输:                $5-10/月
───────────────────────────────
总计:                    ~$70-75/月
```

### 应用 + RDS 部署
```
EC2 实例 (t3.large):     $60/月
RDS (db.t3.medium):      $50/月
EBS 存储:                $10/月
数据传输:                $10/月
───────────────────────────────
总计:                    ~$130/月
```

### 高性能部署
```
EC2 实例 (t3.xlarge):    $120/月
RDS (db.t3.large):       $100/月
EBS 存储:                $20/月
负载均衡器:              $20/月
数据传输:                $20/月
───────────────────────────────
总计:                    ~$280/月
```

**注意**: 以上价格为估算，实际价格可能因地区、使用量等因素有所不同。

---

## 部署步骤概览

1. **创建 EC2 实例**
   - 选择 Ubuntu 22.04 LTS
   - 选择实例类型（推荐 t3.large）
   - 配置安全组
   - 创建并关联密钥对

2. **安装基础软件**
   - Node.js 18+
   - pnpm
   - PostgreSQL (或使用 RDS)
   - Nginx
   - PM2

3. **部署应用**
   - 克隆代码仓库
   - 安装依赖
   - 构建应用
   - 配置环境变量

4. **配置数据库**
   - 创建数据库
   - 运行迁移
   - 配置连接

5. **配置反向代理**
   - 配置 Nginx
   - 设置 SSL 证书
   - 配置域名

6. **启动服务**
   - 使用 PM2 启动应用
   - 配置自动启动
   - 设置监控

---

## 推荐配置总结

### 对于大多数生产环境

**推荐配置**: **t3.large + RDS db.t3.medium**

- **成本**: ~$130/月
- **性能**: 满足中小规模生产需求
- **可扩展性**: 易于升级
- **可靠性**: 数据库自动备份

### 对于初期/测试环境

**推荐配置**: **t3.medium (单机部署)**

- **成本**: ~$35/月
- **性能**: 满足测试和小规模使用
- **部署**: 简单快速

### 对于大规模生产环境

**推荐配置**: **t3.xlarge + RDS db.t3.large + ALB**

- **成本**: ~$280/月
- **性能**: 高性能、高可用
- **扩展性**: 易于水平扩展

---

## 注意事项

1. **数据库备份**: 如果使用 RDS，启用自动备份；如果本地部署，配置定期备份脚本
2. **SSL 证书**: 生产环境必须使用 HTTPS，使用 Let's Encrypt 免费证书
3. **防火墙**: 只开放必要的端口，限制 SSH 访问
4. **监控**: 配置 CloudWatch 监控，设置告警
5. **日志**: 配置日志轮转，避免磁盘空间不足
6. **更新**: 定期更新系统和依赖包
7. **安全**: 使用强密码，定期轮换密钥

---

## 参考链接

- [AWS EC2 实例类型](https://aws.amazon.com/ec2/instance-types/)
- [AWS RDS PostgreSQL](https://aws.amazon.com/rds/postgresql/)
- [AWS 定价计算器](https://calculator.aws/)
- [Node.js 部署最佳实践](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)

